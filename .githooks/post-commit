#!/usr/bin/env bash
export PS4='[\D{%H:%M:%S}] ${BASH_SOURCE##*/}:${LINENO}> '
set -xeuo pipefail

# Live logging for the hook
if command -v ts >/dev/null 2>&1; then
  exec > >(ts '[%H:%M:%S]' | tee -a post-commit.log) 2>&1
else
  exec > >(tee -a post-commit.log) 2>&1
fi
export PS4='[${LINENO}] '; set -x

SHA=$(git rev-parse --short HEAD)
IMAGE="loop-lab-builder:$SHA"

docker build -t "$IMAGE" .

# Remove any previous generator with same name
docker rm -f loop-lab-generator 2>/dev/null || true

docker run -d --name loop-lab-generator --privileged \
  -v /dev:/dev -v "$PWD":/work -w /work \
  "$IMAGE" \
  bash -lc '/usr/local/bin/build_template.sh'

echo "[hook] Generator 'loop-lab-generator' is now running."
echo "[hook]   docker logs -f   loop-lab-generator"
echo "[hook]   docker exec -it loop-lab-generator bash"
